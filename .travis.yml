sudo: required

language: python

python:
  - "2.7"

services:
  - docker
  - postgresql
  - rabbitmq
  - redis-server

addons:
  postgresql: "9.6"

virtualenv:
  system_site_packages: true

env:
  global:
    - AUTH_DISABLED=1
    - SECRET_KEY=123213123123213213
    - LAUNCH_BY_NAME_indexer_inception=1
    - LAUNCH_BY_NAME_retriever_inception=1
    - LAUNCH_BY_NAME_detector_coco=1
    - TRAVISTEST=1
    - INIT_MODELS=ewogICJtb2RlbHMiOiBbCiAgICB7CiAgICAgICJtb2RlbF90eXBlIjogIkQiLAogICAgICAibmFtZSI6ICJjb2NvIiwKICAgICAgImRldGVjdG9yX3R5cGUiOiAiVCIsCiAgICAgICJhbGdvcml0aG0iOiAibW9iaWxlbmV0X3NzZCIsCiAgICAgICJmaWxlbmFtZSI6ICJjb2NvX21vYmlsZW5ldC5wYiIsCiAgICAgICJmaWxlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAidXJsIjogImh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3Mvbnp6MjZiMnA0d3h5Z2czL2NvY29fbW9iaWxlbmV0LnBiIiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJjb2NvX21vYmlsZW5ldC5wYiIKICAgICAgICB9CiAgICAgIF0sCiAgICAgICJtb2RlIjogIlQiLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJjbGFzc19pbmRleF90b19zdHJpbmciOiB7CiAgICAgICAgICAiMSI6ICJwZXJzb24iLAogICAgICAgICAgIjIiOiAiYmljeWNsZSIsCiAgICAgICAgICAiMyI6ICJjYXIiLAogICAgICAgICAgIjQiOiAibW90b3JjeWNsZSIsCiAgICAgICAgICAiNSI6ICJhaXJwbGFuZSIsCiAgICAgICAgICAiNiI6ICJidXMiLAogICAgICAgICAgIjciOiAidHJhaW4iLAogICAgICAgICAgIjgiOiAidHJ1Y2siLAogICAgICAgICAgIjkiOiAiYm9hdCIsCiAgICAgICAgICAiMTAiOiAidHJhZmZpYyBsaWdodCIsCiAgICAgICAgICAiMTEiOiAiZmlyZSBoeWRyYW50IiwKICAgICAgICAgICIxMyI6ICJzdG9wIHNpZ24iLAogICAgICAgICAgIjE0IjogInBhcmtpbmcgbWV0ZXIiLAogICAgICAgICAgIjE1IjogImJlbmNoIiwKICAgICAgICAgICIxNiI6ICJiaXJkIiwKICAgICAgICAgICIxNyI6ICJjYXQiLAogICAgICAgICAgIjE4IjogImRvZyIsCiAgICAgICAgICAiMTkiOiAiaG9yc2UiLAogICAgICAgICAgIjIwIjogInNoZWVwIiwKICAgICAgICAgICIyMSI6ICJjb3ciLAogICAgICAgICAgIjIyIjogImVsZXBoYW50IiwKICAgICAgICAgICIyMyI6ICJiZWFyIiwKICAgICAgICAgICIyNCI6ICJ6ZWJyYSIsCiAgICAgICAgICAiMjUiOiAiZ2lyYWZmZSIsCiAgICAgICAgICAiMjciOiAiYmFja3BhY2siLAogICAgICAgICAgIjI4IjogInVtYnJlbGxhIiwKICAgICAgICAgICIzMSI6ICJoYW5kYmFnIiwKICAgICAgICAgICIzMiI6ICJ0aWUiLAogICAgICAgICAgIjMzIjogInN1aXRjYXNlIiwKICAgICAgICAgICIzNCI6ICJmcmlzYmVlIiwKICAgICAgICAgICIzNSI6ICJza2lzIiwKICAgICAgICAgICIzNiI6ICJzbm93Ym9hcmQiLAogICAgICAgICAgIjM3IjogInNwb3J0cyBiYWxsIiwKICAgICAgICAgICIzOCI6ICJraXRlIiwKICAgICAgICAgICIzOSI6ICJiYXNlYmFsbCBiYXQiLAogICAgICAgICAgIjQwIjogImJhc2ViYWxsIGdsb3ZlIiwKICAgICAgICAgICI0MSI6ICJza2F0ZWJvYXJkIiwKICAgICAgICAgICI0MiI6ICJzdXJmYm9hcmQiLAogICAgICAgICAgIjQzIjogInRlbm5pcyByYWNrZXQiLAogICAgICAgICAgIjQ0IjogImJvdHRsZSIsCiAgICAgICAgICAiNDYiOiAid2luZSBnbGFzcyIsCiAgICAgICAgICAiNDciOiAiY3VwIiwKICAgICAgICAgICI0OCI6ICJmb3JrIiwKICAgICAgICAgICI0OSI6ICJrbmlmZSIsCiAgICAgICAgICAiNTAiOiAic3Bvb24iLAogICAgICAgICAgIjUxIjogImJvd2wiLAogICAgICAgICAgIjUyIjogImJhbmFuYSIsCiAgICAgICAgICAiNTMiOiAiYXBwbGUiLAogICAgICAgICAgIjU0IjogInNhbmR3aWNoIiwKICAgICAgICAgICI1NSI6ICJvcmFuZ2UiLAogICAgICAgICAgIjU2IjogImJyb2Njb2xpIiwKICAgICAgICAgICI1NyI6ICJjYXJyb3QiLAogICAgICAgICAgIjU4IjogImhvdCBkb2ciLAogICAgICAgICAgIjU5IjogInBpenphIiwKICAgICAgICAgICI2MCI6ICJkb251dCIsCiAgICAgICAgICAiNjEiOiAiY2FrZSIsCiAgICAgICAgICAiNjIiOiAiY2hhaXIiLAogICAgICAgICAgIjYzIjogImNvdWNoIiwKICAgICAgICAgICI2NCI6ICJwb3R0ZWQgcGxhbnQiLAogICAgICAgICAgIjY1IjogImJlZCIsCiAgICAgICAgICAiNjciOiAiZGluaW5nIHRhYmxlIiwKICAgICAgICAgICI3MCI6ICJ0b2lsZXQiLAogICAgICAgICAgIjcyIjogInR2IiwKICAgICAgICAgICI3MyI6ICJsYXB0b3AiLAogICAgICAgICAgIjc0IjogIm1vdXNlIiwKICAgICAgICAgICI3NSI6ICJyZW1vdGUiLAogICAgICAgICAgIjc2IjogImtleWJvYXJkIiwKICAgICAgICAgICI3NyI6ICJjZWxsIHBob25lIiwKICAgICAgICAgICI3OCI6ICJtaWNyb3dhdmUiLAogICAgICAgICAgIjc5IjogIm92ZW4iLAogICAgICAgICAgIjgwIjogInRvYXN0ZXIiLAogICAgICAgICAgIjgxIjogInNpbmsiLAogICAgICAgICAgIjgyIjogInJlZnJpZ2VyYXRvciIsCiAgICAgICAgICAiODQiOiAiYm9vayIsCiAgICAgICAgICAiODUiOiAiY2xvY2siLAogICAgICAgICAgIjg2IjogInZhc2UiLAogICAgICAgICAgIjg3IjogInNjaXNzb3JzIiwKICAgICAgICAgICI4OCI6ICJ0ZWRkeSBiZWFyIiwKICAgICAgICAgICI4OSI6ICJoYWlyIGRyaWVyIiwKICAgICAgICAgICI5MCI6ICJ0b290aGJydXNoIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHsKICAgICAgIm1vZGVsX3R5cGUiOiAiRCIsCiAgICAgICJuYW1lIjogInRleHRib3giLAogICAgICAiZmlsZXMiOiBbCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zL2doeG93ZHVhNjVyODJkNi9jaGVja3BvaW50IiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJjaGVja3BvaW50IgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zL3Y5dzRtaGNrczdhNzE5ay9WR0duZXRfZmFzdF9yY25uX2l0ZXJfNTAwMDAuY2twdC5kYXRhLTAwMDAwLW9mLTAwMDAxIiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJWR0duZXRfZmFzdF9yY25uX2l0ZXJfNTAwMDAuY2twdC5kYXRhLTAwMDAwLW9mLTAwMDAxIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zLzJkMGxpY3k4bnB5cGU2ci9WR0duZXRfZmFzdF9yY25uX2l0ZXJfNTAwMDAuY2twdC5pbmRleCIsCiAgICAgICAgICAiZmlsZW5hbWUiOiAiVkdHbmV0X2Zhc3RfcmNubl9pdGVyXzUwMDAwLmNrcHQuaW5kZXgiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAidXJsIjogImh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3MvdndtejJyYTlqb3ZseGpkL1ZHR25ldF9mYXN0X3Jjbm5faXRlcl81MDAwMC5ja3B0Lm1ldGEiLAogICAgICAgICAgImZpbGVuYW1lIjogIlZHR25ldF9mYXN0X3Jjbm5faXRlcl81MDAwMC5ja3B0Lm1ldGEiCiAgICAgICAgfQogICAgICBdLAogICAgICAiYWxnb3JpdGhtIjogIkNUUE4iLAogICAgICAibW9kZSI6ICJUIgogICAgfSwKICAgIHsKICAgICAgIm1vZGVsX3R5cGUiOiAiRCIsCiAgICAgICJuYW1lIjogImZhY2UiLAogICAgICAidXJsIjogbnVsbCwKICAgICAgImZpbGVuYW1lIjogbnVsbCwKICAgICAgImFsZ29yaXRobSI6ICJtdGNubl9mYWNlbmV0IiwKICAgICAgIm1vZGUiOiAiVCIKICAgIH0sCiAgICB7CiAgICAgICJtb2RlbF90eXBlIjogIkkiLAogICAgICAibmFtZSI6ICJpbmNlcHRpb24iLAogICAgICAiZmlsZW5hbWUiOiAibmV0d29yay5wYiIsCiAgICAgICJmaWxlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAidXJsIjogImh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3MvZmM3bGkydnduOGx2c3l1L25ldHdvcmsucGIiLAogICAgICAgICAgImZpbGVuYW1lIjogIm5ldHdvcmsucGIiCiAgICAgICAgfQogICAgICBdLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJjb21wb25lbnRzIjogMjA0OAogICAgICB9LAogICAgICAic2hhc3VtIjogIjQ4YjAyNmNmNzdkZmJkNWQ5ODQxY2NhM2VlNTUwZWYwZWU1YTA3NTEiLAogICAgICAibW9kZSI6ICJUIgogICAgfSwKICAgIHsKICAgICAgIm1vZGVsX3R5cGUiOiAiSSIsCiAgICAgICJuYW1lIjogImZhY2VuZXQiLAogICAgICAiZmlsZXMiOiBbCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zL2p5dHBndzhldDA5ZWRlOS9mYWNlbmV0LnBiIiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJmYWNlbmV0LnBiIgogICAgICAgIH0KICAgICAgXSwKICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAiY29tcG9uZW50cyI6IDEyOAogICAgICB9LAogICAgICAic2hhc3VtIjogIjlmOTljYWNjYmM3NWRjZWU4Y2IwYTU1YTA1NTFkN2M1Y2I4YTY4MzYiLAogICAgICAibW9kZSI6ICJUIgogICAgfSwKICAgIHsKICAgICAgIm1vZGVsX3R5cGUiOiAiQSIsCiAgICAgICJuYW1lIjogImNybm4iLAogICAgICAiZmlsZXMiOiBbCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zL2wwdm84M2htdnYyYWlwbi9jcm5uLnB0aCIsCiAgICAgICAgICAiZmlsZW5hbWUiOiAiY3Jubi5wdGgiCiAgICAgICAgfQogICAgICBdLAogICAgICAibW9kZSI6ICJQIgogICAgfSwKICAgIHsKICAgICAgIm1vZGVsX3R5cGUiOiAiQSIsCiAgICAgICJuYW1lIjogInRhZ2dlciIsCiAgICAgICJmaWxlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAidXJsIjogImh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3MvdW1vMHh0bGptOWFuOTB4L29wZW5faW1hZ2VzLmNrcHQiLAogICAgICAgICAgImZpbGVuYW1lIjogIm9wZW5faW1hZ2VzLmNrcHQiCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAidXJsIjogImh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3MvZjkzYXhkdGxiM2x0ajQwL29wZW5faW1hZ2VzLmNrcHQubWV0YSIsCiAgICAgICAgICAiZmlsZW5hbWUiOiAib3Blbl9pbWFnZXMuY2twdC5tZXRhIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zLzJzZDVuenB5aHNqMTB3NS9vcGVuX2ltYWdlc19sYWJlbG1hcC50eHQiLAogICAgICAgICAgImZpbGVuYW1lIjogIm9wZW5faW1hZ2VzX2xhYmVsbWFwLnR4dCIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly93d3cuZHJvcGJveC5jb20vcy95Ym9xdjRsZWVtNm95MDEvb3Blbl9pbWFnZXNfZGljdC5jc3YiLAogICAgICAgICAgImZpbGVuYW1lIjogIm9wZW5faW1hZ2VzX2RpY3QuY3N2IgogICAgICAgIH0KICAgICAgXSwKICAgICAgIm1vZGUiOiAiVCIKICAgIH0sCiAgICB7CiAgICAgICJmaWxlcyI6IFtdLAogICAgICAibmFtZSI6ICJGQUlTU19QQ0FSMTI4X0lWRjQwOTZfU1E4X29uX0xGVyIsCiAgICAgICJhbGdvcml0aG0iOiAiRkFJU1MiLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJpbmRleGVyX3NoYXN1bSI6ICI5Zjk5Y2FjY2JjNzVkY2VlOGNiMGE1NWEwNTUxZDdjNWNiOGE2ODM2IiwKICAgICAgICAicGF0aCI6ICJodHRwczovL3Zkbi5ueWMzLmRpZ2l0YWxvY2VhbnNwYWNlcy5jb20vbW9kZWxzL1BDQVIxMjhfSVZGNDA5Nl9TUThfTEZXLmR2YV9tb2RlbF9leHBvcnQiCiAgICAgIH0sCiAgICAgICJtb2RlbF90eXBlIjogIlAiCiAgICB9LAogICAgewogICAgICAiZmlsZXMiOiBbCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zLzc3a210MjBqbmgzMWpzZC9laWdlbnZhbHMubnB5IiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJlaWdlbnZhbHMubnB5IgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zLzkyNW9sM3kzMDhzMmlpNS9laWdlbnZlY3MubnB5IiwKICAgICAgICAgICJmaWxlbmFtZSI6ICJlaWdlbnZlY3MubnB5IgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgInVybCI6ICJodHRwczovL3d3dy5kcm9wYm94LmNvbS9zLzRvbThuY2d6ZzBkMXZpeC9tZWFuLm5weSIsCiAgICAgICAgICAiZmlsZW5hbWUiOiAibWVhbi5ucHkiCiAgICAgICAgfQogICAgICBdLAogICAgICAibmFtZSI6ICJJbmNlcHRpb25fUENBX2Zyb21fWW91dHViZThNIiwKICAgICAgImFsZ29yaXRobSI6ICJQQ0EiLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJpbmRleGVyX3NoYXN1bSI6ICI0OGIwMjZjZjc3ZGZiZDVkOTg0MWNjYTNlZTU1MGVmMGVlNWEwNzUxIiwKICAgICAgICAiY29tcG9uZW50cyI6IDEwMjQKICAgICAgfSwKICAgICAgIm1vZGVsX3R5cGUiOiAiUCIsCiAgICAgICJzaGFzdW0iOiAiODY2ODk0MzJhYzA5ZDg2ZGQ5NWQ3ZDNlZDU3MjI3ZDI3ZWIwOWM4MSIKICAgIH0KICBdLAogICJwcm9jZXNzaW5nIjp7ImRhdGFzZXQiOiBbCiAgICB7CiAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9kZXRlY3Rpb24iLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJmcmFtZXNfYmF0Y2hfc2l6ZSI6IDUwMCwKICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgIm5hbWUiOiAiY29jbyIKICAgICAgICB9LAogICAgICAgICJtYXAiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleGluZyIsCiAgICAgICAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICAgICAgICJuYW1lIjogImluY2VwdGlvbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJ0YXJnZXQiOiAicmVnaW9ucyIsCiAgICAgICAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIsCiAgICAgICAgICAgICAgICAid19fZ3RlIjogNTAsCiAgICAgICAgICAgICAgICAiaF9fZ3RlIjogNTAKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJtYXAiOiBbCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleF9hcHByb3hpbWF0aW9uIiwKICAgICAgICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAgICAgICAidGFyZ2V0IjogImluZGV4X2VudHJpZXMiLAogICAgICAgICAgICAgICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAic2hhc3VtIjogIjg2Njg5NDMyYWMwOWQ4NmRkOTVkN2QzZWQ1NzIyN2QyN2ViMDljODEiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgfSwKICAgIHsKICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2RldGVjdGlvbiIsCiAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICJuYW1lIjogImZhY2UiCiAgICAgICAgfSwKICAgICAgICAiZnJhbWVzX2JhdGNoX3NpemUiOiA1MDAsCiAgICAgICAgIm1hcCI6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4aW5nIiwKICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgIm5hbWUiOiAiZmFjZW5ldCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJ0YXJnZXQiOiAicmVnaW9ucyIsCiAgICAgICAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJtYXAiOiBbCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleF9hcHByb3hpbWF0aW9uIiwKICAgICAgICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAgICAgICAidGFyZ2V0IjogImluZGV4X2VudHJpZXMiLAogICAgICAgICAgICAgICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAic2hhc3VtIjogIjVlNGI4NmEwMjY3MjU1NDI2ODM0Mzk2YTVhODU1ZjRmYTc3NTY5MWEiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgfSwKICAgIHsKICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4aW5nIiwKICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgIm5hbWUiOiAiaW5jZXB0aW9uIgogICAgICAgIH0sCiAgICAgICAgImZyYW1lc19iYXRjaF9zaXplIjogNTAwLAogICAgICAgICJ0YXJnZXQiOiAiZnJhbWVzIiwKICAgICAgICAibWFwIjogWwogICAgICAgICAgewogICAgICAgICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1faW5kZXhfYXBwcm94aW1hdGlvbiIsCiAgICAgICAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgICAgICAgInRhcmdldCI6ICJpbmRleF9lbnRyaWVzIiwKICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgInNoYXN1bSI6ICI4NjY4OTQzMmFjMDlkODZkZDk1ZDdkM2VkNTcyMjdkMjdlYjA5YzgxIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9hbmFseXNpcyIsCiAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICJuYW1lIjogInRhZ2dlciIKICAgICAgICB9LAogICAgICAgICJ0YXJnZXQiOiAiZnJhbWVzIiwKICAgICAgICAiZnJhbWVzX2JhdGNoX3NpemUiOiA1MDAKICAgICAgfQogICAgfQogIF0sCiAgImZyYW1lbGlzdCI6IFsKICAgIHsKICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2RldGVjdGlvbiIsCiAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIKICAgICAgICB9LAogICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAibmFtZSI6ICJjb2NvIgogICAgICAgIH0sCiAgICAgICAgIm1hcCI6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4aW5nIiwKICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgIm5hbWUiOiAiaW5jZXB0aW9uIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInRhcmdldCI6ICJyZWdpb25zIiwKICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIiwKICAgICAgICAgICAgICAgICJ3X19ndGUiOiA1MCwKICAgICAgICAgICAgICAgICJoX19ndGUiOiA1MAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgIm1hcCI6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4X2FwcHJveGltYXRpb24iLAogICAgICAgICAgICAgICAgICAiYXJndW1lbnRzIjogewogICAgICAgICAgICAgICAgICAgICJ0YXJnZXQiOiAiaW5kZXhfZW50cmllcyIsCiAgICAgICAgICAgICAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICJzaGFzdW0iOiAiODY2ODk0MzJhYzA5ZDg2ZGQ5NWQ3ZDNlZDU3MjI3ZDI3ZWIwOWM4MSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9CiAgICB9LAogICAgewogICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1fZGV0ZWN0aW9uIiwKICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgIm5hbWUiOiAiZmFjZSIKICAgICAgICB9LAogICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgfSwKICAgICAgICAibWFwIjogWwogICAgICAgICAgewogICAgICAgICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1faW5kZXhpbmciLAogICAgICAgICAgICAiYXJndW1lbnRzIjogewogICAgICAgICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAgICAgICAibmFtZSI6ICJmYWNlbmV0IgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInRhcmdldCI6ICJyZWdpb25zIiwKICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgIm1hcCI6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4X2FwcHJveGltYXRpb24iLAogICAgICAgICAgICAgICAgICAiYXJndW1lbnRzIjogewogICAgICAgICAgICAgICAgICAgICJ0YXJnZXQiOiAiaW5kZXhfZW50cmllcyIsCiAgICAgICAgICAgICAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICJzaGFzdW0iOiAiNWU0Yjg2YTAyNjcyNTU0MjY4MzQzOTZhNWE4NTVmNGZhNzc1NjkxYSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9CiAgICB9LAogICAgewogICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1faW5kZXhpbmciLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAibmFtZSI6ICJpbmNlcHRpb24iCiAgICAgICAgfSwKICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIgogICAgICAgIH0sCiAgICAgICAgInRhcmdldCI6ICJmcmFtZXMiLAogICAgICAgICJtYXAiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleF9hcHByb3hpbWF0aW9uIiwKICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAidGFyZ2V0IjogImluZGV4X2VudHJpZXMiLAogICAgICAgICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAgICAgICAic2hhc3VtIjogIjg2Njg5NDMyYWMwOWQ4NmRkOTVkN2QzZWQ1NzIyN2QyN2ViMDljODEiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgfSwKICAgIHsKICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2FuYWx5c2lzIiwKICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgIm5hbWUiOiAidGFnZ2VyIgogICAgICAgIH0sCiAgICAgICAgInRhcmdldCI6ICJmcmFtZXMiLAogICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgXSwKICAidmlkZW8iOiBbCiAgICB7CiAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9kZXRlY3Rpb24iLAogICAgICAiYXJndW1lbnRzIjogewogICAgICAgICJmaWx0ZXJzIjogIl9fcGFyZW50X18iLAogICAgICAgICJ0cmFpbmVkbW9kZWxfc2VsZWN0b3IiOiB7CiAgICAgICAgICAibmFtZSI6ICJjb2NvIgogICAgICAgIH0sCiAgICAgICAgIm1hcCI6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4aW5nIiwKICAgICAgICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgIm5hbWUiOiAiaW5jZXB0aW9uIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInRhcmdldCI6ICJyZWdpb25zIiwKICAgICAgICAgICAgICAiZmlsdGVycyI6IHsKICAgICAgICAgICAgICAgICJldmVudF9pZCI6ICJfX3BhcmVudF9ldmVudF9fIiwKICAgICAgICAgICAgICAgICJ3X19ndGUiOiA1MCwKICAgICAgICAgICAgICAgICJoX19ndGUiOiA1MAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgIm1hcCI6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgIm9wZXJhdGlvbiI6ICJwZXJmb3JtX2luZGV4X2FwcHJveGltYXRpb24iLAogICAgICAgICAgICAgICAgICAiYXJndW1lbnRzIjogewogICAgICAgICAgICAgICAgICAgICJ0YXJnZXQiOiAiaW5kZXhfZW50cmllcyIsCiAgICAgICAgICAgICAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICJzaGFzdW0iOiAiODY2ODk0MzJhYzA5ZDg2ZGQ5NWQ3ZDNlZDU3MjI3ZDI3ZWIwOWM4MSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9CiAgICB9LAogICAgewogICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1fZGV0ZWN0aW9uIiwKICAgICAgImFyZ3VtZW50cyI6IHsKICAgICAgICAiZmlsdGVycyI6ICJfX3BhcmVudF9fIiwKICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgIm5hbWUiOiAiZmFjZSIKICAgICAgICB9LAogICAgICAgICJtYXAiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleGluZyIsCiAgICAgICAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICAgICAgICJuYW1lIjogImZhY2VuZXQiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAidGFyZ2V0IjogInJlZ2lvbnMiLAogICAgICAgICAgICAgICJmaWx0ZXJzIjogewogICAgICAgICAgICAgICAgImV2ZW50X2lkIjogIl9fcGFyZW50X2V2ZW50X18iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAibWFwIjogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1faW5kZXhfYXBwcm94aW1hdGlvbiIsCiAgICAgICAgICAgICAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRhcmdldCI6ICJpbmRleF9lbnRyaWVzIiwKICAgICAgICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgICAgICAgInNoYXN1bSI6ICI1ZTRiODZhMDI2NzI1NTQyNjgzNDM5NmE1YTg1NWY0ZmE3NzU2OTFhIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9pbmRleGluZyIsCiAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICJuYW1lIjogImluY2VwdGlvbiIKICAgICAgICB9LAogICAgICAgICJ0YXJnZXQiOiAiZnJhbWVzIiwKICAgICAgICAiZmlsdGVycyI6ICJfX3BhcmVudF9fIiwKICAgICAgICAibWFwIjogWwogICAgICAgICAgewogICAgICAgICAgICAib3BlcmF0aW9uIjogInBlcmZvcm1faW5kZXhfYXBwcm94aW1hdGlvbiIsCiAgICAgICAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgICAgICAgInRhcmdldCI6ICJpbmRleF9lbnRyaWVzIiwKICAgICAgICAgICAgICAidHJhaW5lZG1vZGVsX3NlbGVjdG9yIjogewogICAgICAgICAgICAgICAgInNoYXN1bSI6ICI4NjY4OTQzMmFjMDlkODZkZDk1ZDdkM2VkNTcyMjdkMjdlYjA5YzgxIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImZpbHRlcnMiOiB7CiAgICAgICAgICAgICAgICAiZXZlbnRfaWQiOiAiX19wYXJlbnRfZXZlbnRfXyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH0KICAgIH0sCiAgICB7CiAgICAgICJvcGVyYXRpb24iOiAicGVyZm9ybV9hbmFseXNpcyIsCiAgICAgICJhcmd1bWVudHMiOiB7CiAgICAgICAgInRyYWluZWRtb2RlbF9zZWxlY3RvciI6IHsKICAgICAgICAgICJuYW1lIjogInRhZ2dlciIKICAgICAgICB9LAogICAgICAgICJ0YXJnZXQiOiAiZnJhbWVzIiwKICAgICAgICAiZmlsdGVycyI6ICJfX3BhcmVudF9fIgogICAgICB9CiAgICB9CiAgXX0sCiAgImV4dGVybmFsIjogWwogICAgICAgICB7InVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vVmlzdWFsRGF0YU5ldHdvcmsvcm9vdCIsICJuYW1lIjogIlZETiJ9CiAgXQp9Cgo=
    - export BLASLDFLAGS="/usr/lib/libopenblas.so.0"

before_install:
  - sudo apt-get -qq update
  - wget https://www.dropbox.com/s/bjyzb8hytdwp2tp/ffmpeg-release-64bit-static.tar.xz && tar xvfJ ffmpeg-release-64bit-static.tar.xz
  - shasum ffmpeg-release-64bit-static.tar.xz | awk '$1!="a93bce9e510afef02f7e2592f6b5d117dcd08854"{exit 1}'
  - sudo mv ffmpeg*/* /bin/
  - sudo apt-get -qq install -y pkg-config python-dev unzip swig swig3.0 libopenblas-dev liblapack-dev libopencv-dev libhdf5-dev python-pip libav-tools libjpeg-dev  libpng-dev  libtiff-dev  libjasper-dev  python-numpy python-scipy  python-pycurl  python-opencv
  - sudo dpkg -L python-opencv
  - sudo wget --quiet https://yt-dl.org/downloads/latest/youtube-dl -O /bin/youtube-dl
  - sudo chmod a+rx /bin/youtube-dl
  - youtube-dl -U
  - pip install -q --only-binary=numpy,scipy numpy scipy
  - pip install -q https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-1.12.0-cp27-none-linux_x86_64.whl
  - pip install -q --no-deps keras
  - pip install -q --no-deps h5py
  - pip install -q --no-cache-dir http://download.pytorch.org/whl/cpu/torch-0.3.1-cp27-cp27mu-linux_x86_64.whl
  - pip install -q torchvision
  - git clone --recursive https://github.com/facebookresearch/faiss && cd faiss && git reset --hard a91a24e77a3e16f0336eb8b70770bdf5daa1154e && git apply /home/travis/build/AKSHAYUBHAT/DeepVideoAnalytics/deploy/dockerfiles/faiss.patch && ./configure && sudo make -j $(nproc) && sudo make install && sudo make py && cd ..
#  - mkdir -p dlib && git clone https://github.com/davisking/dlib.git dlib/ && cd  dlib/ && python setup.py install --yes USE_AVX_INSTRUCTIONS && cd ..
  - sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
  - sudo chmod +x /usr/local/bin/docker-compose

install: "pip install -q -r requirements.txt > /dev/null"


before_script:
  - mkdir ~/media
  - export PYTHONPATH="${PYTHONPATH}:../faiss/python/"
  - export PYTHONPATH="${PYTHONPATH}:repos/"
  - export PYTHONPATH="${PYTHONPATH}:repos/tf_ctpn_cpu/"
  - cd repos/lopq/python && python setup.py install && cd ../../..
  - cd repos/tf_ctpn_cpu/lib/utils && ./make.sh && cd ../../../..
  - cd server && ./migrate.sh && cd ..
  - cd tests/data && wget --quiet https://www.dropbox.com/s/t4bgkh2w2ow8o10/WorldIsNotEnough.mp4 && cd ../..
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  - cd server && python manage.py runserver 8000 &
  - cp tests/data/test_config.json config.json


script:
  - cd server && ./init_fs.py && cd ..
  - cd tests && python test_ci.py && python test_ci_face.py && cd ..
  - cd server && ./launch_from_env.py && cd ..
  - cd tests && python test_ci_search.py && cd ..
  - cd server && python scripts/generate_testing_token.py && cp creds.json ../ && cd ..
  - python tests/test_ci_client.py
  - wget --quiet localhost:8000
  - wget --quiet localhost:8000/videos/
  - wget --quiet localhost:8000/queries/
  - wget --quiet localhost:8000/queries/1/
  - wget --quiet localhost:8000/tasks/
  - wget --quiet localhost:8000/retrievers/
  - wget --quiet localhost:8000/textsearch/
  - wget --quiet localhost:8000/models/
  - wget --quiet localhost:8000/indexes/
  - wget --quiet localhost:8000/api/users/
  - wget --quiet localhost:8000/api/videos/
  - wget --quiet localhost:8000/api/tubes/
  - wget --quiet localhost:8000/api/frames/
  - wget --quiet localhost:8000/api/regionrelations/
  - wget --quiet localhost:8000/api/tuberelations/
  - wget --quiet localhost:8000/api/tuberegionrelations/
  - wget --quiet localhost:8000/api/segments/
  - wget --quiet localhost:8000/api/regions/
  - wget --quiet localhost:8000/api/queries/
  - wget --quiet localhost:8000/api/queryresults/
  - wget --quiet localhost:8000/api/indexentries/
  - wget --quiet localhost:8000/api/events/
  - wget --quiet localhost:8000/api/restarts/
  - wget --quiet localhost:8000/api/workers/
  - wget --quiet localhost:8000/api/system_state/
  - wget --quiet localhost:8000/api/retriever_state/
  - fuser -k 8000/tcp
#  - ./dvactl start &
#  - sleep 420 && docker logs webserver
#  - ./dvactl clean
